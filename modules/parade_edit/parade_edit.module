<?php

/**
 * @file
 * Code for Parade Edit.
 */

use Drupal\Component\Utility\Html;
use Drupal\Core\Url;
use Drupal\parade_edit\Plugin\Menu\ViewTab;
use Drupal\parade_edit\Plugin\Menu\EditTab;
use Drupal\parade_edit\Plugin\Menu\ParadeEditorTab;

/**
 * Implements hook_page_attachments_alter().
 *
 * Disable Quick edit functionality on node/ID page.
 */
function parade_edit_page_attachments_alter(array &$attachments) {
  $route_match = \Drupal::routeMatch();
  if ($route_match->getRouteName() === 'entity.node.canonical') {
    if ($index = array_search('quickedit/quickedit', $attachments['#attached']['library'])) {
      unset($attachments['#attached']['library'][$index]);
    }
    if ($index = array_search('contextual/drupal.contextual-links', $attachments['#attached']['library'])) {
      unset($attachments['#attached']['library'][$index]);
    }
  }
}

/**
 * Implements hook_preprocess_HOOK().
 *
 * Using hook_preprocess_field().
 * Disable Geysir functionality on node/ID page and for nested paragraphs.
 */
function parade_edit_preprocess_field(&$vars) {
  if (empty($vars['field_type']) || $vars['field_type'] !== 'entity_reference_revisions') {
    return;
  }

  if (isset($vars['attributes']['data-geysir-field-paragraph-field-wrapper'])) {
    $disable_geysir = FALSE;
    $route_match = \Drupal::routeMatch();
    if (in_array($route_match->getRouteName(), [
      'entity.node.canonical',
      'geysir.modal.edit_form',
      'entity.node.latest_version',
      'geysir.modal.up',
      'geysir.modal.down',
    ])) {
      // Disable on node view.
      if ($route_match->getRouteName() === 'entity.node.canonical') {
        unset($vars['attributes']['data-geysir-field-paragraph-field-wrapper']);
        $disable_geysir = TRUE;
      }
      $element = &$vars['element'];
      $delta = 0;
      while (!empty($element[$delta])) {
        // Disable on node view and for parade_paragraphs nested field.
        if ($disable_geysir || $vars['field_name'] === 'parade_paragraphs') {
          if (($key = array_search('geysir_field_paragraph_wrapper', $vars['items'][$delta]['content']['#theme_wrappers'])) !== FALSE) {
            unset($vars['items'][$delta]['content']['#theme_wrappers'][$key]);
          }
          unset($vars['items'][$delta]['content']['#geysir_field_paragraph_links']);
        }
        $delta++;
      }
    }
  }
}

/**
 * Implements hook_library_info_alter().
 */
function parade_edit_library_info_alter(&$libraries, $extension) {
  // TODO: rewrite this and patch geyzir, do this with service.
  if ($extension == "geysir") {
    // Remove useless css. This will prevent to overwrite css rules.
    $libraries['paragraphs']['css'] = [];
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function parade_edit_preprocess_node(&$variables) {
  // Remove Work moderation control form from the last version page...
  if (\Drupal::routeMatch()->getRouteName() === "entity.node.latest_version") {
    $variables['content']['_field_layout']['content']['workbench_moderation_control']['#access'] = FALSE;

    // Just attach to this page's content our geysir styles.
    // TODO: rewrite this and patch geyzir, do this with service.
    $variables['content']['_field_layout']['content']['#attached']['library'][] = 'parade_edit/paragraphs';
  }
}

/**
 * Implements hook_local_tasks_alter().
 *
 * Alter View, Edit, Latest version TABs for nodes.
 */
function parade_edit_local_tasks_alter(&$local_tasks) {
  // View, Edit, Latest version TAB rename for our bundles.
  $local_tasks['entity.node.canonical']['class'] = ViewTab::class;
  $local_tasks['entity.node.canonical']['entity_type_id'] = 'node';

  $local_tasks['entity.node.edit_form']['class'] = EditTab::class;
  $local_tasks['entity.node.edit_form']['entity_type_id'] = 'node';
  $local_tasks['entity.node.edit_form']['weight'] = -1.1;

  $local_tasks['moderation_state.entities:node.latest_version_tab']['class'] = ParadeEditorTab::class;
  $local_tasks['moderation_state.entities:node.latest_version_tab']['entity_type_id'] = 'node';
  $local_tasks['moderation_state.entities:node.latest_version_tab']['weight'] = -1;
}
